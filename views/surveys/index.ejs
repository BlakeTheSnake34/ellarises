<!DOCTYPE html>
<html>
<head>
  <title>Survey Results</title>
  <link rel="stylesheet" href="/css/main.css">

  <style>
    .survey-search-bar {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .survey-input,
    .survey-select {
      flex: 1;
      min-width: 220px;
      height: 48px;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .comment-btn {
      background: var(--er-blue);
      color: var(--er-charcoal);
      padding: 4px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 600;
    }

    .comment-btn:hover {
      background: var(--er-blush);
    }

    th a {
      color: var(--er-cream);
      text-decoration: underline;
      cursor: pointer;
    }

    .er-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    .er-modal-box {
      background: white;
      width: 520px;
      max-height: 70vh;
      border-radius: 14px;
      padding: 1.5rem;
      overflow-y: auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }

    .er-modal-close {
      display: inline-block;
      margin-top: 1rem;
      background: var(--er-blue);
      padding: .5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      border: none;
    }
    .er-modal-close:hover {
      background: var(--er-blush);
    }
  </style>
</head>

<body>

<%- include('../partials/_nav') %>
<%- include('../partials/_flash') %>

<div class="page-wrap survey-wide">
  <div class="page survey-wide-page">

    <h1>Survey Results</h1>

    <!-- Search + Filters -->
    <form method="GET" action="/surveys" class="survey-search-bar">

      <input type="text"
             name="search"
             placeholder="Search by name, email, or event..."
             value="<%= search %>"
             class="survey-input">

      <select name="event" class="survey-select">
        <option value="">All Events</option>
        <% eventsList.forEach(e => { %>
        <option value="<%= e.eventname %>" <%= event === e.eventname ? 'selected' : '' %>><%= e.eventname %></option>
        <% }) %>
      </select>

      <select name="sort" class="survey-select">
        <option value="date_desc" <%= sort === 'date_desc' ? 'selected' : '' %>>Newest First</option>
        <option value="date_asc"  <%= sort === 'date_asc'  ? 'selected' : '' %>>Oldest First</option>
        <option value="event_asc" <%= sort === 'event_asc' ? 'selected' : '' %>>Event A → Z</option>
        <option value="event_desc"<%= sort === 'event_desc'? 'selected' : '' %>>Event Z → A</option>
        <option value="name_asc"  <%= sort === 'name_asc'  ? 'selected' : '' %>>Name A → Z</option>
        <option value="name_desc" <%= sort === 'name_desc' ? 'selected' : '' %>>Name Z → A</option>
      </select>

      <button type="submit" class="btn-primary">Apply</button>
    </form>

    <!-- TABLE -->
    <div style="overflow-x:auto;">
      <table class="survey-table">
        <thead>
          <tr>
            <th>Participant</th>
            <th>Email</th>

            <th><a href="/surveys?sort=<%= sort === 'event_asc' ? 'event_desc' : 'event_asc' %>&search=<%= search %>&event=<%= event %>">Event</a></th>

            <th>Start Time</th>

            <th><a href="/surveys?sort=<%= sort === 'overall_asc' ? 'overall_desc' : 'overall_asc' %>&search=<%= search %>&event=<%= event %>">Overall</a></th>
            <th><a href="/surveys?sort=<%= sort === 'satisfaction_asc' ? 'satisfaction_desc' : 'satisfaction_asc' %>&search=<%= search %>&event=<%= event %>">Satisfaction</a></th>
            <th><a href="/surveys?sort=<%= sort === 'usefulness_asc' ? 'usefulness_desc' : 'usefulness_asc' %>&search=<%= search %>&event=<%= event %>">Usefulness</a></th>
            <th><a href="/surveys?sort=<%= sort === 'instructor_asc' ? 'instructor_desc' : 'instructor_asc' %>&search=<%= search %>&event=<%= event %>">Instructor</a></th>
            <th><a href="/surveys?sort=<%= sort === 'recommend_asc' ? 'recommend_desc' : 'recommend_asc' %>&search=<%= search %>&event=<%= event %>">Recommend</a></th>

            <th>NPS</th>
            <th>Comments</th>
            <th>Submitted</th>
          </tr>
        </thead>

        <tbody>
          <% surveys.forEach(s => { %>
          <tr>

            <td><%= s.participantfirstname %> <%= s.participantlastname %></td>
            <td><%= s.participantemail %></td>
            <td><%= s.eventname %></td>
            <td><%= new Date(s.eventdatetimestart).toLocaleString() %></td>

            <td style="text-align:center;"><%= s.surveyoverallscore %></td>
            <td style="text-align:center;"><%= s.surveysatisfactionscore %></td>
            <td style="text-align:center;"><%= s.surveyusefulnessscore %></td>
            <td style="text-align:center;"><%= s.surveyinstructorscore %></td>
            <td style="text-align:center;"><%= s.surveyrecommendationscore %></td>

            <td style="text-align:center;"><%= s.surveynpsbucket %></td>

            <td style="text-align:center;">
              <% if (s.surveycomments && s.surveycomments.trim()) { %>
                <button 
                  class="comment-btn open-comment" 
                  data-comment="<%= s.surveycomments.replace(/"/g, '&quot;') %>">
                  View
                </button>
              <% } else { %>—<% } %>
            </td>

            <td><%= new Date(s.surveysubmissiondate).toLocaleString() %></td>

          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- PAGINATION WITH PAGE JUMP -->
    <div style="margin-top:1.5rem; text-align:right; display:flex; justify-content:flex-end; gap:1rem; align-items:center;">

      <% if (currentPage > 1) { %>
      <a class="btn-edit"
         href="/surveys?page=<%= currentPage - 1 %>&search=<%= search %>&sort=<%= sort %>&event=<%= event %>">← Prev</a>
      <% } %>

      <form method="GET" action="/surveys" style="display:flex; gap:.4rem; align-items:center;">
        <span>Page</span>

        <input 
          type="number" 
          name="page" 
          value="<%= currentPage %>" 
          min="1" 
          max="<%= totalPages %>"
          style="width:65px; padding:.3rem .5rem; border-radius:8px;"
        >

        <span>of <%= totalPages %></span>

        <!-- KEEP FILTERS -->
        <input type="hidden" name="search" value="<%= search %>">
        <input type="hidden" name="sort"   value="<%= sort %>">
        <input type="hidden" name="event"  value="<%= event %>">

        <button class="btn-edit" type="submit">Go</button>
      </form>

      <% if (currentPage < totalPages) { %>
      <a class="btn-edit"
         href="/surveys?page=<%= currentPage + 1 %>&search=<%= search %>&sort=<%= sort %>&event=<%= event %>">Next →</a>
      <% } %>

    </div>

  </div>
</div>

<!-- MODAL -->
<div id="erModal" class="er-modal-overlay">
  <div class="er-modal-box">
    <h3>Survey Comment</h3>
    <p id="erModalText"></p>
    <button class="er-modal-close" id="erModalClose">Close</button>
  </div>
</div>

<script src="/js/survey-modal.js"></script>

</body>
</html>
