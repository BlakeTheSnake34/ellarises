<!DOCTYPE html>
<html>
<head>
  <title>Survey Results</title>
  <link rel="stylesheet" href="/css/main.css">

  <style>
    /* Search bar styling */
    .survey-search-bar {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .survey-input,
    .survey-select {
      flex: 1;
      min-width: 220px;
      height: 48px;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    /* Modal trigger button */
    .comment-btn {
      background: var(--er-blue);
      color: var(--er-charcoal);
      padding: 4px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 600;
    }
    .comment-btn:hover {
      background: var(--er-blush);
    }

    /* Sortable headers */
    th a {
      color: var(--er-cream);
      text-decoration: underline;
      cursor: pointer;
    }

    /* Modal overlay */
    .er-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    /* Modal box */
    .er-modal-box {
      background: white;
      width: 520px;
      max-height: 70vh;
      border-radius: 14px;
      padding: 1.5rem;
      overflow-y: auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }

    .er-modal-box h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.4rem;
      color: var(--er-charcoal);
    }

    .er-modal-close {
      display: inline-block;
      margin-top: 1rem;
      background: var(--er-blue);
      padding: .5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      border: none;
    }
    .er-modal-close:hover {
      background: var(--er-blush);
    }

  </style>
</head>

<body>

<%- include('../partials/_nav') %>
<%- include('../partials/_flash') %>

<div class="page-wrap survey-wide">
  <div class="page survey-wide-page">

    <h1>Survey Results</h1>

    <!-- Search + Filters + Sort -->
    <form method="GET" action="/surveys" class="survey-search-bar">

      <input type="text"
             name="search"
             placeholder="Search by name, email, or event..."
             value="<%= search %>"
             class="survey-input">

      <!-- Event Filter -->
      <select name="event" class="survey-select">
        <option value="">All Events</option>
        <% eventsList.forEach(e => { %>
          <option value="<%= e.eventname %>" <%= event === e.eventname ? "selected" : "" %>>
            <%= e.eventname %>
          </option>
        <% }) %>
      </select>

      <!-- Sort dropdown -->
      <select name="sort" class="survey-select">
        <option value="date_desc" <%= sort === "date_desc" ? "selected" : "" %>>Newest First</option>
        <option value="date_asc"  <%= sort === "date_asc"  ? "selected" : "" %>>Oldest First</option>
        <option value="event_asc" <%= sort === "event_asc" ? "selected" : "" %>>Event A ‚Üí Z</option>
        <option value="event_desc"<%= sort === "event_desc"? "selected" : "" %>>Event Z ‚Üí A</option>
        <option value="name_asc"  <%= sort === "name_asc"  ? "selected" : "" %>>Name A ‚Üí Z</option>
        <option value="name_desc" <%= sort === "name_desc" ? "selected" : "" %>>Name Z ‚Üí A</option>
      </select>

      <button type="submit" class="btn-primary">Apply</button>
    </form>

    <!-- TABLE -->
    <div style="overflow-x: auto;">
      <table class="survey-table">
        <thead>
          <tr>
            <th>Participant</th>
            <th>Email</th>

            <th><a href="/surveys?sort=<%= sort === 'event_asc' ? 'event_desc' : 'event_asc' %>&search=<%= search %>&event=<%= event %>">Event</a></th>

            <th>Start Time</th>

            <th><a href="/surveys?sort=<%= sort === 'overall_asc' ? 'overall_desc' : 'overall_asc' %>&search=<%= search %>&event=<%= event %>">Overall</a></th>
            <th><a href="/surveys?sort=<%= sort === 'satisfaction_asc' ? 'satisfaction_desc' : 'satisfaction_asc' %>&search=<%= search %>&event=<%= event %>">Satisfaction</a></th>
            <th><a href="/surveys?sort=<%= sort === 'usefulness_asc' ? 'usefulness_desc' : 'usefulness_asc' %>&search=<%= search %>&event=<%= event %>">Usefulness</a></th>
            <th><a href="/surveys?sort=<%= sort === 'instructor_asc' ? 'instructor_desc' : 'instructor_asc' %>&search=<%= search %>&event=<%= event %>">Instructor</a></th>
            <th><a href="/surveys?sort=<%= sort === 'recommend_asc' ? 'recommend_desc' : 'recommend_asc' %>&search=<%= search %>&event=<%= event %>">Recommend</a></th>

            <th>NPS</th>
            <th>Comments</th>
            <th>Submitted</th>
          </tr>
        </thead>

        <tbody>
          <% surveys.forEach(s => { %>
            <tr>

              <td><%= s.participantfirstname %> <%= s.participantlastname %></td>
              <td><%= s.participantemail %></td>
              <td><%= s.eventname %></td>
              <td><%= s.eventdatetimestart ? new Date(s.eventdatetimestart).toLocaleString() : "N/A" %></td>

              <td style="text-align:center;"><%= s.surveyoverallscore %></td>
              <td style="text-align:center;"><%= s.surveysatisfactionscore %></td>
              <td style="text-align:center;"><%= s.surveyusefulnessscore %></td>
              <td style="text-align:center;"><%= s.surveyinstructorscore %></td>
              <td style="text-align:center;"><%= s.surveyrecommendationscore %></td>

              <td style="text-align:center;"><%= s.surveynpsbucket %></td>

              <td style="text-align:center;">
                <% if (s.surveycomments && s.surveycomments.trim() !== "") { %>
                  <button 
                    class="comment-btn open-comment" 
                    data-comment="<%= s.surveycomments.replace(/"/g, '&quot;') %>">
                    View
                  </button>
                <% } else { %>
                  ‚Äî
                <% } %>
              </td>

              <td><%= s.surveysubmissiondate ? new Date(s.surveysubmissiondate).toLocaleString() : "N/A" %></td>

            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    <div style="margin-top: 1.5rem; text-align:right;">
      <% if (currentPage > 1) { %>
        <a class="btn-edit" 
           href="/surveys?page=<%= currentPage - 1 %>&search=<%= search %>&sort=<%= sort %>&event=<%= event %>">‚Üê Prev</a>
      <% } %>

      <span style="margin:0 10px;font-weight:600;">
        Page <%= currentPage %> of <%= totalPages %>
      </span>

      <% if (currentPage < totalPages) { %>
        <a class="btn-edit" 
           href="/surveys?page=<%= currentPage + 1 %>&search=<%= search %>&sort=<%= sort %>&event=<%= event %>">Next ‚Üí</a>
      <% } %>
    </div>

  </div>
</div>

<!-- üî• MODAL HTML -->
<div id="erModal" class="er-modal-overlay">
  <div class="er-modal-box">
    <h3>Survey Comment</h3>
    <p id="erModalText"></p>
    <button class="er-modal-close" id="erModalClose">Close</button>
  </div>
</div>

<script src="/js/survey-modal.js"></script>

</body>
</html>
