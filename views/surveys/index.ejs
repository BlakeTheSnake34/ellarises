<!DOCTYPE html>
<html>
<head>
  <title>Survey Results</title>
  <link rel="stylesheet" href="/css/main.css">

  <style>
    .survey-search-bar {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .survey-input,
    .survey-select {
      flex: 1;
      min-width: 220px;
      height: 48px;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .survey-apply-btn {
      height: 48px;
      padding: 0 1.5rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
    }

    .survey-table {
      min-width: 1700px;
      border-collapse: collapse;
    }

    /* Sortable headers */
    th.sortable a {
      color: var(--er-cream);
      text-decoration: none;
      font-weight: 600;
    }
    th.sortable a:hover {
      color: var(--er-pink);
      text-decoration: underline;
    }

    .comment-toggle-btn {
      background: var(--er-blue);
      color: var(--er-charcoal);
      border: none;
      padding: 3px 10px;
      font-size: 0.75rem;
      border-radius: 10px;
      cursor: pointer;
      margin-left: 6px;
    }

    .comment-toggle-btn:hover {
      background: var(--er-blush);
    }
  </style>
</head>

<body>

<%- include('../partials/_nav') %>
<%- include('../partials/_flash') %>

<div class="page-wrap survey-wide">
  <div class="page survey-wide-page">

    <h1>Survey Results</h1>

    <!-- Search + Filters + Sort -->
    <form method="GET" action="/surveys" class="survey-search-bar">

      <input type="text"
             name="search"
             placeholder="Search by name, email, or event..."
             value="<%= search %>"
             class="survey-input">

      <select name="event" class="survey-select">
        <option value="">All Events</option>
        <% eventsList.forEach(e => { %>
          <option value="<%= e.eventname %>" <%= event === e.eventname ? "selected" : "" %>>
            <%= e.eventname %>
          </option>
        <% }) %>
      </select>

      <select name="sort" class="survey-select">
        <option value="date_desc" <%= sort === "date_desc" ? "selected" : "" %>>Newest First</option>
        <option value="date_asc"  <%= sort === "date_asc"  ? "selected" : "" %>>Oldest First</option>
        <option value="event_asc" <%= sort === "event_asc" ? "selected" : "" %>>Event A → Z</option>
        <option value="event_desc"<%= sort === "event_desc"? "selected" : "" %>>Event Z → A</option>
        <option value="name_asc"  <%= sort === "name_asc"  ? "selected" : "" %>>Name A → Z</option>
        <option value="name_desc" <%= sort === "name_desc" ? "selected" : "" %>>Name Z → A</option>
      </select>

      <button type="submit" class="btn-primary survey-apply-btn">Apply</button>
    </form>

    <!-- TABLE -->
    <div style="overflow-x: auto;">
      <table class="survey-table">
        <thead>
          <tr>
            <th>Participant</th>
            <th>Email</th>
            <th>Event</th>
            <th>Start Time</th>

            <!-- CLICKABLE SORTING HEADERS -->
            <th class="sortable">
              <a href="/surveys?sort=<%= sort === 'overall_asc' ? 'overall_desc' : 'overall_asc' %>&search=<%= search %>&event=<%= event %>">
                Overall Score
              </a>
            </th>

            <th class="sortable">
              <a href="/surveys?sort=<%= sort === 'satisfaction_asc' ? 'satisfaction_desc' : 'satisfaction_asc' %>&search=<%= search %>&event=<%= event %>">
                Satisfaction
              </a>
            </th>

            <th class="sortable">
              <a href="/surveys?sort=<%= sort === 'usefulness_asc' ? 'usefulness_desc' : 'usefulness_asc' %>&search=<%= search %>&event=<%= event %>">
                Usefulness
              </a>
            </th>

            <th class="sortable">
              <a href="/surveys?sort=<%= sort === 'instructor_asc' ? 'instructor_desc' : 'instructor_asc' %>&search=<%= search %>&event=<%= event %>">
                Instructor
              </a>
            </th>

            <th class="sortable">
              <a href="/surveys?sort=<%= sort === 'recommend_asc' ? 'recommend_desc' : 'recommend_asc' %>&search=<%= search %>&event=<%= event %>">
                Recommend
              </a>
            </th>

            <th>NPS Score</th>
            <th>Comments</th>
            <th>Submitted</th>
          </tr>
        </thead>

        <tbody>
          <% surveys.forEach(s => { %>
            <tr>

              <td><%= s.participantfirstname %> <%= s.participantlastname %></td>
              <td><%= s.participantemail %></td>
              <td><%= s.eventname %></td>
              <td><%= s.eventdatetimestart ? new Date(s.eventdatetimestart).toLocaleString() : "N/A" %></td>

              <td><%= s.surveyoverallscore %></td>
              <td><%= s.surveysatisfactionscore %></td>
              <td><%= s.surveyusefulnessscore %></td>
              <td><%= s.surveyinstructorscore %></td>
              <td><%= s.surveyrecommendationscore %></td>
              <td><%= s.surveynpsbucket %></td>

              <!-- Comments -->
              <td class="comment-cell">
                <% if (s.surveycomments && s.surveycomments.length > 120) { %>

                  <span class="comment-short"><%= s.surveycomments.slice(0, 120) %>...</span>
                  <span class="comment-full" style="display:none;"><%= s.surveycomments %></span>

                  <button type="button" class="comment-toggle-btn btn-more">More</button>
                  <button type="button" class="comment-toggle-btn btn-less" style="display:none;">Less</button>

                <% } else { %>
                  <%= s.surveycomments || "" %>
                <% } %>
              </td>

              <td><%= s.surveysubmissiondate ? new Date(s.surveysubmissiondate).toLocaleString() : "N/A" %></td>

            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    <div style="margin-top: 1.5rem; text-align: right;">
      <% if (currentPage > 1) { %>
        <a class="btn-edit"
           href="/surveys?page=<%= currentPage - 1 %>&search=<%= search %>&sort=<%= sort %>&event=<%= event %>">
          ← Prev
        </a>
      <% } %>

      <span style="margin: 0 10px; font-weight: 600;">
        Page <%= currentPage %> of <%= totalPages %>
      </span>

      <% if (currentPage < totalPages) { %>
        <a class="btn-edit"
           href="/surveys?page=<%= currentPage + 1 %>&search=<%= search %>&sort=<%= sort %>&event=<%= event %>">
          Next →
        </a>
      <% } %>
    </div>

  </div>
</div>

<script src="/js/survey-comments.js"></script>

</body>
</html>
